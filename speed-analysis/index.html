<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E7 Combat Detect</title>
    <style>
        .image-container {
            width: 500px;
            height: 500px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            margin-bottom: 10px;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        #findButton {
            width: 100px;
            height: 100px;
            font-size: 16px;
        }

        #images {
            display: flex;
            gap: 20px;
        }

        h3 {
            text-align: center;
            margin-bottom: 5px;
        }

        #result {
            margin-top: 20px;
            font-size: 14px;
        }

        #statusMessage {
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            color: blue;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        td img {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>

<h1>E7 Character & Combat Detect</h1>

<div id="images">
    <div>
        <h3>Input Image</h3> <!-- Input Image -->
        <div class="image-container">
            <img id="inputImage" src="default_image.png" alt="Input Image">
        </div>
    </div>
    <div>
        <h3>Output Image</h3> <!-- Result Image -->
        <div class="image-container">
            <img id="resultImage" src="default_image.png" alt="Result Image">
        </div>
    </div>
</div>

<br>
Load Image From File: <input type="file" accept="image/*" id="imageInput" onchange="loadImage()">
<br><br>

<!-- API Key input -->
API Key: <input type="text" id="apiKey" placeholder="Enter API Key">
<br><br>

<button id="findButton" onclick="findCharacters()">Find Characters</button>

<!-- Status Message Area -->
<div id="statusMessage"></div>

<div id="result">
    <h2>Character Detection Results</h2>

    <!-- Dynamic Table for Characters and Combat Info -->
    <table id="characterTable">
        <!-- Table Headers -->
        <thead>
            <tr>
                <th>Character</th>
                <th>Combat Info</th>
                <th>Speed</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>

    <h2>Inference Results (Raw Data)</h2>
    <pre id="resultText"></pre>
</div>

<script>
    let imageInput = document.getElementById('imageInput');
    let inputImage = document.getElementById('inputImage');
    let resultImage = document.getElementById('resultImage');
    let resultText = document.getElementById('resultText');
    let statusMessage = document.getElementById('statusMessage');
    let characterTable = document.getElementById('characterTable').querySelector('tbody');

    const apiUrl = "https://detect.roboflow.com/e7_character_combat/1"; // Fixed API URL

    // Display default image on page load
    window.onload = function () {
        inputImage.src = "default_image.png";
        resultImage.src = "default_image.png";
        statusMessage.innerText = ''; // Clear status message on load
    };

    function loadImage() {
        const file = imageInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                // Display the uploaded image in the input image element
                inputImage.src = e.target.result;
                statusMessage.innerText = 'Image loaded. Ready for detection.'; // Update status
            };
            reader.readAsDataURL(file);
        }
    }

function findCharacters() {
    if (inputImage.getAttribute('src') === "default_image.png") {
        alert("Please upload an image first."); 
        return;
    }

    const apiKeyInput = document.getElementById('apiKey').value;

    if (!apiKeyInput) {
        alert("Please provide an API Key.");
        return;
    }

    statusMessage.innerText = 'Uploading image...';

    const imgSrc = inputImage.getAttribute('src');
    const base64Image = imgSrc.split(',')[1];

    fetch(`${apiUrl}?api_key=${apiKeyInput}&format=image`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: base64Image,
    })
    .then(response => response.blob())
    .then(blob => {
        const objectURL = URL.createObjectURL(blob);
        resultImage.src = objectURL;
        statusMessage.innerText = 'Detection completed. Displaying results...';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the image.');
        statusMessage.innerText = 'Error occurred during image processing.';
    });

    fetch(`${apiUrl}?api_key=${apiKeyInput}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: base64Image,
    })
    .then(response => response.json())
    .then(data => {
        resultText.innerHTML = JSON.stringify(data, null, 2);
        characterTable.innerHTML = ''; // Clear previous table data

        const characters = data.predictions.filter(pred => pred.class === 'ally' || pred.class === 'enemy');
        
        // Sort characters based on their 'y' value
        characters.sort((a, b) => a.y - b.y);

        // Iterate through sorted characters and assign combat info
        characters.forEach((character, index) => {
            const row = document.createElement('tr');
            
            // Cropped character image
            const charCell = document.createElement('td');
            const charImg = document.createElement('img');
            charImg.src = character.cropped_image_url || 'default_image.png'; // Update with correct cropped image
            charCell.appendChild(charImg);
            row.appendChild(charCell);

            // Find nearest combat by comparing 'y' values
            let nearestCombat = null;
            for (let i = 0; i < data.predictions.length; i++) {
                const combat = data.predictions[i];
                if (combat.class === 'combat' && (!nearestCombat || Math.abs(combat.y - character.y) < Math.abs(nearestCombat.y - character.y))) {
                    nearestCombat = combat;
                }
            }

            // Combat information
            const combatCell = document.createElement('td');
            combatCell.innerText = nearestCombat ? nearestCombat.combat_info : 'N/A'; // Adjust combat info as needed
            row.appendChild(combatCell);

            // Speed (initialize to 0)
            const speedCell = document.createElement('td');
            speedCell.innerText = '0'; 
            row.appendChild(speedCell);

            characterTable.appendChild(row);
        });

    })
    .catch(error => {
        console.error('Error:', error);
        statusMessage.innerText = 'Error occurred while fetching the results.';
    });
}
</script>

</body>
</html>
